{"ast":null,"code":"'use strict';\n\nconst promisify = require('promisify-es6');\nconst EventEmitter = require('events');\nconst eos = require('end-of-stream');\nconst isNode = require('detect-node');\nconst setImmediate = require('async/setImmediate');\nconst PubsubMessageStream = require('./utils/pubsub-message-stream');\nconst stringlistToArray = require('./utils/stringlist-to-array');\nconst moduleConfig = require('./utils/module-config');\nconst NotSupportedError = () => new Error('pubsub is currently not supported when run in the browser');\n\n/* Public API */\nmodule.exports = arg => {\n  const send = moduleConfig(arg);\n\n  /* Internal subscriptions state and functions */\n  const ps = new EventEmitter();\n  const subscriptions = {};\n  ps.id = Math.random();\n  return {\n    subscribe: (topic, handler, options, callback) => {\n      const defaultOptions = {\n        discover: false\n      };\n      if (typeof options === 'function') {\n        callback = options;\n        options = defaultOptions;\n      }\n      if (!options) {\n        options = defaultOptions;\n      }\n\n      // Throw an error if ran in the browsers\n      if (!isNode) {\n        if (!callback) {\n          return Promise.reject(NotSupportedError());\n        }\n        return setImmediate(() => callback(NotSupportedError()));\n      }\n\n      // promisify doesn't work as we always pass a\n      // function as last argument (`handler`)\n      if (!callback) {\n        return new Promise((resolve, reject) => {\n          subscribe(topic, handler, options, err => {\n            if (err) {\n              return reject(err);\n            }\n            resolve();\n          });\n        });\n      }\n      subscribe(topic, handler, options, callback);\n    },\n    unsubscribe: (topic, handler, callback) => {\n      if (!isNode) {\n        if (!callback) {\n          return Promise.reject(NotSupportedError());\n        }\n        return setImmediate(() => callback(NotSupportedError()));\n      }\n      if (ps.listenerCount(topic) === 0 || !subscriptions[topic]) {\n        const err = new Error(`Not subscribed to '${topic}'`);\n        if (!callback) {\n          return Promise.reject(err);\n        }\n        return setImmediate(() => callback(err));\n      }\n      ps.removeListener(topic, handler);\n\n      // Drop the request once we are actually done\n      if (ps.listenerCount(topic) === 0) {\n        if (!callback) {\n          return new Promise((resolve, reject) => {\n            // When the response stream has ended, resolve the promise\n            eos(subscriptions[topic].res, err => {\n              // FIXME: Artificial timeout needed to ensure unsubscribed\n              setTimeout(() => {\n                if (err) return reject(err);\n                resolve();\n              });\n            });\n            subscriptions[topic].req.abort();\n            subscriptions[topic] = null;\n          });\n        }\n\n        // When the response stream has ended, call the callback\n        eos(subscriptions[topic].res, err => {\n          // FIXME: Artificial timeout needed to ensure unsubscribed\n          setTimeout(() => callback(err));\n        });\n        subscriptions[topic].req.abort();\n        subscriptions[topic] = null;\n        return;\n      }\n      if (!callback) {\n        return Promise.resolve();\n      }\n      setImmediate(() => callback());\n    },\n    publish: promisify((topic, data, callback) => {\n      if (!isNode) {\n        return callback(NotSupportedError());\n      }\n      if (!Buffer.isBuffer(data)) {\n        return callback(new Error('data must be a Buffer'));\n      }\n      const request = {\n        path: 'pubsub/pub',\n        args: [topic, data]\n      };\n      send(request, callback);\n    }),\n    ls: promisify(callback => {\n      if (!isNode) {\n        return callback(NotSupportedError());\n      }\n      const request = {\n        path: 'pubsub/ls'\n      };\n      send.andTransform(request, stringlistToArray, callback);\n    }),\n    peers: promisify((topic, callback) => {\n      if (!isNode) {\n        return callback(NotSupportedError());\n      }\n      const request = {\n        path: 'pubsub/peers',\n        args: [topic]\n      };\n      send.andTransform(request, stringlistToArray, callback);\n    }),\n    setMaxListeners(n) {\n      return ps.setMaxListeners(n);\n    }\n  };\n  function subscribe(topic, handler, options, callback) {\n    ps.on(topic, handler);\n    if (subscriptions[topic]) {\n      // TODO: should a callback error be returned?\n      return callback();\n    }\n\n    // Request params\n    const request = {\n      path: 'pubsub/sub',\n      args: [topic],\n      qs: {\n        discover: options.discover\n      }\n    };\n\n    // Start the request and transform the response\n    // stream to Pubsub messages stream\n    subscriptions[topic] = {};\n    subscriptions[topic].req = send.andTransform(request, PubsubMessageStream.from, (err, stream) => {\n      if (err) {\n        subscriptions[topic] = null;\n        ps.removeListener(topic, handler);\n        return callback(err);\n      }\n      subscriptions[topic].res = stream;\n      stream.on('data', msg => {\n        ps.emit(topic, msg);\n      });\n      stream.on('error', err => {\n        ps.emit('error', err);\n      });\n      eos(stream, err => {\n        if (err) {\n          ps.emit('error', err);\n        }\n        subscriptions[topic] = null;\n        ps.removeListener(topic, handler);\n      });\n      callback();\n    });\n  }\n};","map":{"version":3,"names":["promisify","require","EventEmitter","eos","isNode","setImmediate","PubsubMessageStream","stringlistToArray","moduleConfig","NotSupportedError","Error","module","exports","arg","send","ps","subscriptions","id","Math","random","subscribe","topic","handler","options","callback","defaultOptions","discover","Promise","reject","resolve","err","unsubscribe","listenerCount","removeListener","res","setTimeout","req","abort","publish","data","Buffer","isBuffer","request","path","args","ls","andTransform","peers","setMaxListeners","n","on","qs","from","stream","msg","emit"],"sources":["/home/isaak/Workspace/ipfsDapp/client/node_modules/ipfs-api/src/pubsub.js"],"sourcesContent":["'use strict'\n\nconst promisify = require('promisify-es6')\nconst EventEmitter = require('events')\nconst eos = require('end-of-stream')\nconst isNode = require('detect-node')\nconst setImmediate = require('async/setImmediate')\nconst PubsubMessageStream = require('./utils/pubsub-message-stream')\nconst stringlistToArray = require('./utils/stringlist-to-array')\nconst moduleConfig = require('./utils/module-config')\n\nconst NotSupportedError = () => new Error('pubsub is currently not supported when run in the browser')\n\n/* Public API */\nmodule.exports = (arg) => {\n  const send = moduleConfig(arg)\n\n  /* Internal subscriptions state and functions */\n  const ps = new EventEmitter()\n  const subscriptions = {}\n  ps.id = Math.random()\n  return {\n    subscribe: (topic, handler, options, callback) => {\n      const defaultOptions = {\n        discover: false\n      }\n\n      if (typeof options === 'function') {\n        callback = options\n        options = defaultOptions\n      }\n\n      if (!options) {\n        options = defaultOptions\n      }\n\n      // Throw an error if ran in the browsers\n      if (!isNode) {\n        if (!callback) {\n          return Promise.reject(NotSupportedError())\n        }\n\n        return setImmediate(() => callback(NotSupportedError()))\n      }\n\n      // promisify doesn't work as we always pass a\n      // function as last argument (`handler`)\n      if (!callback) {\n        return new Promise((resolve, reject) => {\n          subscribe(topic, handler, options, (err) => {\n            if (err) {\n              return reject(err)\n            }\n            resolve()\n          })\n        })\n      }\n\n      subscribe(topic, handler, options, callback)\n    },\n    unsubscribe: (topic, handler, callback) => {\n      if (!isNode) {\n        if (!callback) {\n          return Promise.reject(NotSupportedError())\n        }\n\n        return setImmediate(() => callback(NotSupportedError()))\n      }\n\n      if (ps.listenerCount(topic) === 0 || !subscriptions[topic]) {\n        const err = new Error(`Not subscribed to '${topic}'`)\n\n        if (!callback) {\n          return Promise.reject(err)\n        }\n\n        return setImmediate(() => callback(err))\n      }\n\n      ps.removeListener(topic, handler)\n\n      // Drop the request once we are actually done\n      if (ps.listenerCount(topic) === 0) {\n        if (!callback) {\n          return new Promise((resolve, reject) => {\n            // When the response stream has ended, resolve the promise\n            eos(subscriptions[topic].res, (err) => {\n              // FIXME: Artificial timeout needed to ensure unsubscribed\n              setTimeout(() => {\n                if (err) return reject(err)\n                resolve()\n              })\n            })\n            subscriptions[topic].req.abort()\n            subscriptions[topic] = null\n          })\n        }\n\n        // When the response stream has ended, call the callback\n        eos(subscriptions[topic].res, (err) => {\n          // FIXME: Artificial timeout needed to ensure unsubscribed\n          setTimeout(() => callback(err))\n        })\n        subscriptions[topic].req.abort()\n        subscriptions[topic] = null\n        return\n      }\n\n      if (!callback) {\n        return Promise.resolve()\n      }\n\n      setImmediate(() => callback())\n    },\n    publish: promisify((topic, data, callback) => {\n      if (!isNode) {\n        return callback(NotSupportedError())\n      }\n\n      if (!Buffer.isBuffer(data)) {\n        return callback(new Error('data must be a Buffer'))\n      }\n\n      const request = {\n        path: 'pubsub/pub',\n        args: [topic, data]\n      }\n\n      send(request, callback)\n    }),\n    ls: promisify((callback) => {\n      if (!isNode) {\n        return callback(NotSupportedError())\n      }\n\n      const request = {\n        path: 'pubsub/ls'\n      }\n\n      send.andTransform(request, stringlistToArray, callback)\n    }),\n    peers: promisify((topic, callback) => {\n      if (!isNode) {\n        return callback(NotSupportedError())\n      }\n\n      const request = {\n        path: 'pubsub/peers',\n        args: [topic]\n      }\n\n      send.andTransform(request, stringlistToArray, callback)\n    }),\n    setMaxListeners (n) {\n      return ps.setMaxListeners(n)\n    }\n  }\n\n  function subscribe (topic, handler, options, callback) {\n    ps.on(topic, handler)\n\n    if (subscriptions[topic]) {\n      // TODO: should a callback error be returned?\n      return callback()\n    }\n\n    // Request params\n    const request = {\n      path: 'pubsub/sub',\n      args: [topic],\n      qs: {\n        discover: options.discover\n      }\n    }\n\n    // Start the request and transform the response\n    // stream to Pubsub messages stream\n    subscriptions[topic] = {}\n    subscriptions[topic].req = send.andTransform(request, PubsubMessageStream.from, (err, stream) => {\n      if (err) {\n        subscriptions[topic] = null\n        ps.removeListener(topic, handler)\n        return callback(err)\n      }\n\n      subscriptions[topic].res = stream\n\n      stream.on('data', (msg) => {\n        ps.emit(topic, msg)\n      })\n\n      stream.on('error', (err) => {\n        ps.emit('error', err)\n      })\n\n      eos(stream, (err) => {\n        if (err) {\n          ps.emit('error', err)\n        }\n\n        subscriptions[topic] = null\n        ps.removeListener(topic, handler)\n      })\n\n      callback()\n    })\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}